{"version":3,"sources":["assets/scripts/systems/storySys/storySysMgr.js"],"names":["cc","Class","Component","properties","contentNode","Node","storyTextNodePrefab","Prefab","disBetweenStoryTextNodes","continueLabelNode","completeButtonNode","startDelayTime","storyId","storyTextNodes","status","get","_status","set","value","active","node","getChildByName","log","header","footer","sectionDis","totalHeight","totalTextNodeNum","currentNum","textIds","onLoad","self","bg","width","winSize","height","monitoredNode","on","str","require","getTextByIdAndLanguageType","_showOneStoryText","completeStory","getComponent","Label","string","tween","repeatForever","to","opacity","start","scrollContainer","y","tempHeight","showStory","storyConfig","key","toString","config","length","delay","call","networkMgr","messageObj","makeMessageObj","message","playerId","playerData","id","successCallBack","xhr","response","responseText","JSON","parse","type","storySysId","closeSystem","Button","interactable","sendMessageByMsgObj","instantiate","_forceUpdateRenderData","ScrollView","vertical","addChild","onWillOpend","givenStoryId"],"mappings":"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","sourceRoot":"/","sourcesContent":["// Learn cc.Class:\n//  - [Chinese] https://docs.cocos.com/creator/manual/zh/scripting/class.html\n//  - [English] http://docs.cocos2d-x.org/creator/manual/en/scripting/class.html\n// Learn Attribute:\n//  - [Chinese] https://docs.cocos.com/creator/manual/zh/scripting/reference/attributes.html\n//  - [English] http://docs.cocos2d-x.org/creator/manual/en/scripting/reference/attributes.html\n// Learn life-cycle callbacks:\n//  - [Chinese] https://docs.cocos.com/creator/manual/zh/scripting/life-cycle-callbacks.html\n//  - [English] https://www.cocos2d-x.org/docs/creator/manual/en/scripting/life-cycle-callbacks.html\n\ncc.Class({\n    extends: cc.Component,\n\n    properties: {\n        // foo: {\n        //     // ATTRIBUTES:\n        //     default: null,        // The default value will be used only when the component attaching\n        //                           // to a node for the first time\n        //     type: cc.SpriteFrame, // optional, default is typeof default\n        //     serializable: true,   // optional, default is true\n        // },\n        // bar: {\n        //     get () {\n        //         return this._bar;\n        //     },\n        //     set (value) {\n        //         this._bar = value;\n        //     }\n        // },\n        contentNode: cc.Node,\n        storyTextNodePrefab: cc.Prefab,\n        disBetweenStoryTextNodes: 50,\n        continueLabelNode: cc.Node,\n        completeButtonNode: cc.Node,\n        startDelayTime: 1,\n        storyId: null,\n\n        storyTextNodes: [],\n        status: {\n            get() {\n                return this._status\n            },\n            set(value) {\n                this._status = value\n                // 1 = start showing a node\n                // 2 = showing complete , wating for tap to next\n                // 3 = all nodes showing complete , wating for click button to complete\n                switch(value) {\n                    case 1:\n                        this.continueLabelNode.active = false\n                        this.completeButtonNode.active = false\n                        this.node.getChildByName(\"tapMonitoredNode\").active = false\n                        break\n                    case 2:\n                        this.continueLabelNode.active = true\n                        this.completeButtonNode.active = false\n                        this.node.getChildByName(\"tapMonitoredNode\").active = true\n                        break\n                    case 3:\n                        this.continueLabelNode.active = false\n                        this.completeButtonNode.active = true\n                        this.node.getChildByName(\"tapMonitoredNode\").active = false\n                        break\n                    default:\n                        cc.log(\"STORYSYSMGR: WRONG STATUS VALUE PROVIDED\")\n                }\n            }\n        },\n        header: 100,\n        footer: 100,\n        sectionDis: 50,\n\n        totalHeight: 0,\n        totalTextNodeNum: null,\n        currentNum: null,\n        textIds: null\n    },\n\n    // LIFE-CYCLE CALLBACKS:\n\n    onLoad () {\n        var self = this\n        var bg = this.node.getChildByName(\"bg\")\n        bg.width = cc.winSize.width\n        bg.height = cc.winSize.height\n        this.node.width = bg.width\n        this.node.height = bg.height\n        var monitoredNode = this.node.getChildByName(\"tapMonitoredNode\")\n        monitoredNode.width = bg.width\n        monitoredNode.height = bg.height\n\n        //cc.log(bg.width,bg.height)\n        monitoredNode.on(\"touchstart\",function(){\n            if (self.status == 2) {\n                self.currentNum += 1\n                var str = require(\"textConfig\").getTextByIdAndLanguageType(self.textIds[self.currentNum - 1])\n                self._showOneStoryText(str)\n            }\n        },this)\n        this.completeButtonNode.on(\"click\",function(){\n            if (self.status == 3) {\n                self.completeStory()\n            }\n        })\n        this.completeButtonNode.getChildByName(\"New Label\").getComponent(cc.Label).string = require(\"textConfig\").getTextByIdAndLanguageType(122)\n\n        cc.tween(this.continueLabelNode)\n            .repeatForever(cc.tween()\n                    .to(0.3, {opacity: 0})\n                    .to(0.3, {opacity: 255})    \n            )\n            .start()\n\n        var scrollContainer = this.node.getChildByName(\"scrollContainer\")\n        scrollContainer.y = bg.height / 2 - this.footer\n        this.continueLabelNode.y = -bg.height / 2 + this.footer + this.completeButtonNode.height / 2\n        this.completeButtonNode.y = -bg.height / 2 + this.footer + this.completeButtonNode.height / 2\n\n        var tempHeight = bg.height - this.header - this.footer - this.completeButtonNode.height - this.sectionDis\n        scrollContainer.height = tempHeight\n        scrollContainer.getChildByName(\"view\").height = tempHeight\n        this.contentNode.height = tempHeight\n    },\n\n    start () {\n\n        this.showStory()\n    },\n\n    showStory() {\n        if (this.storyId == null) {\n            cc.log(\"NO STORY ID PROVIDED\")\n            return\n        }\n        var storyConfig = require(\"storyConfig\")\n        var key = \"story_\" + this.storyId.toString()\n        var config = storyConfig[key]\n        var textIds = config.textIds\n        this.textIds = textIds\n        this.totalTextNodeNum = textIds.length\n        \n        this.currentNum = 1\n        var str = require(\"textConfig\").getTextByIdAndLanguageType(textIds[0])\n        var self = this\n        cc.tween(this.node)\n            .delay(self.startDelayTime)\n            .call(function(){\n                self._showOneStoryText(str)\n            })\n            .start()\n    },\n\n    completeStory() {\n        var networkMgr = require(\"networkMgr\")\n        var messageObj = networkMgr.makeMessageObj(\"storyModule\",\"completeCurrentMessageType\")\n        messageObj.message.playerId = require(\"dataMgr\").playerData.id\n        messageObj.successCallBack = function(xhr) {\n            var response = xhr.responseText\n            response = JSON.parse(response)\n            if (response.type == \"success\") {\n                var storyId = response.storyId\n                require(\"dataMgr\").playerData.storySysId = storyId\n                require(\"systemsMgr\").closeSystem(\"storySys\",3)\n            }\n        }\n        \n        this.completeButtonNode.getComponent(cc.Button).interactable = false\n        networkMgr.sendMessageByMsgObj(messageObj)\n    },\n\n    _showOneStoryText(str) {\n        this.status = 1\n        var node = cc.instantiate(this.storyTextNodePrefab)\n        node.getComponent(cc.Label).string = str\n        node.getComponent(cc.Label)._forceUpdateRenderData()\n        node.y = -this.totalHeight\n\n        this.totalHeight += node.height + this.disBetweenStoryTextNodes\n        if (this.contentNode.height < this.totalHeight) {\n            this.contentNode.height = this.totalHeight\n            this.node.getChildByName(\"scrollContainer\").getComponent(cc.ScrollView).vertical = true\n        }\n        node.opacity = 0\n        this.contentNode.addChild(node)\n        var self = this\n        cc.tween(node)\n            .to(0.5,{opacity: 255})\n            .call(function(){\n                if (self.currentNum == self.totalTextNodeNum) {\n                    self.status = 3\n                }\n                else {\n                    self.status = 2\n                }\n            })\n            .start()\n    },\n\n    onWillOpend(givenStoryId) {\n        this.storyId = givenStoryId\n    }\n    // update (dt) {},\n});\n"]}