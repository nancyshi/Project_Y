{"version":3,"sources":["../../../../assets/scripts/assets/scripts/levelMgr.js"],"names":["cc","Class","extends","Component","properties","bullets","minDis","maxOffsetDegree","directionTryto","flag","helper","walls","targetsNum","get","_targetsNum","set","value","onSuccess","linePrefab","Prefab","bulletPrefab","playerData","retryButton","Node","heartForRetryCost","_heartForRetryCostwe","getChildByName","getComponent","Label","string","toString","heart","_heart","find","maxHeart","Button","interactable","_maxHeart","onLoad","Helper","require","start","node","on","onTouchStart","onTouchMove","onTouchEnd","bulletsNode","children","currentLevel","delegate","wallsNode","length","graphic","Graphics","startPoint","pointNodes","index","point","moveTo","x","y","lineTo","close","stroke","fill","event","delta","getDelta","direction","getPossiableDirection","equals","startLocation","getStartLocation","disFromStart","v2","getLocationX","getLocationY","mag","moveBullets","onDestroy","off","isPossiableWithGivenDirection","givenDirection","angle","signAngle","degree","Math","PI","abs","status","shadows","bullet","bulletMgr","nearestWallInfo","getNearestWallInfo","shadowNode","suitablePosition","width","height","dis","originNode","push","resolveShadows","targetPosition","movingDirection","log","oneShadow","i","anotherShadow","testResult","_selectStaticShadowAndShaodwForResolved","staticShadow","tempShadow","shadowForResolved","staticBorderLines","getLinesOfOneNode","staticLine","ray","makeRay","k","line","rayTest","newPoint2","p2","p1","newPoint1","ray1","position","currentDistance","targetDis","getDisToSelfBorder","disFromBorder","getSuitablePoint","updatedDis","shadow1","shadow2","temp","s1","s2","d","target","givenType","points","getPointsOfOneNode","lines","key","result","generateWalls","levelConfig","config","wallPathes","onePath","realPoints","realPoint","currentPoint","lineWidth","offset","wallNodes","isClosed","instantiate","directedLine","offsetDirection","rotate","normalizeSelf","addChild","bulletConfig","con","scale","onClickRetryButton","msgObj","makeMessageObj","message","id","playerId","commitBody","self","successCallBack","xhr","response","responseText","JSON","parse","type","director","loadScene","sendMessageByMsgObj","onAllRetryFailed"],"mappings":"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","file":"levelMgr.js","sourceRoot":"../../../../assets/scripts","sourcesContent":["// Learn cc.Class:\n//  - [Chinese] https://docs.cocos.com/creator/manual/zh/scripting/class.html\n//  - [English] http://docs.cocos2d-x.org/creator/manual/en/scripting/class.html\n// Learn Attribute:\n//  - [Chinese] https://docs.cocos.com/creator/manual/zh/scripting/reference/attributes.html\n//  - [English] http://docs.cocos2d-x.org/creator/manual/en/scripting/reference/attributes.html\n// Learn life-cycle callbacks:\n//  - [Chinese] https://docs.cocos.com/creator/manual/zh/scripting/life-cycle-callbacks.html\n//  - [English] https://www.cocos2d-x.org/docs/creator/manual/en/scripting/life-cycle-callbacks.html\n\ncc.Class({\n    extends: cc.Component,\n\n    properties: {\n        // foo: {\n        //     // ATTRIBUTES:\n        //     default: null,        // The default value will be used only when the component attaching\n        //                           // to a node for the first time\n        //     type: cc.SpriteFrame, // optional, default is typeof default\n        //     serializable: true,   // optional, default is true\n        // },\n        // bar: {\n        //     get () {\n        //         return this._bar;\n        //     },\n        //     set (value) {\n        //         this._bar = value;\n        //     }\n        // },\n        bullets: [],\n        minDis: 100,\n        maxOffsetDegree: 30,\n        directionTryto: null,\n        flag: false,\n        helper: null,\n\n        walls: [],\n        targetsNum: {\n            get() {\n                return this._targetsNum\n            },\n            set(value) {\n                this._targetsNum = value\n                if (value == 0) {\n                    this.onSuccess()\n                }\n            }\n        },\n\n        linePrefab: cc.Prefab,\n        bulletPrefab: cc.Prefab,\n\n\n        playerData: null,\n        retryButton: cc.Node,\n        heartForRetryCost: {\n            get() {\n                return this._heartForRetryCostwe\n            },\n            set(value){\n                this._heartForRetryCostwe = value\n                this.retryButton.getChildByName(\"heartCostLabel\").getComponent(cc.Label).string = value.toString()\n            } \n        },\n\n        heart: {\n            get() {\n                return this._heart\n            },\n            set(value) {\n                this._heart = value\n                cc.find(\"Canvas/uiNode/heartLabel\").getComponent(cc.Label).string = value.toString() + \" / \" + this.maxHeart.toString()\n                if (value < this.heartForRetryCost) {\n                    this.retryButton.getComponent(cc.Button).interactable = false\n                }\n                else {\n                    this.retryButton.getComponent(cc.Button).interactable = true\n                }\n            }\n        },\n\n        maxHeart: {\n            get() {\n                return this._maxHeart\n            },\n            set(value) {\n                this._maxHeart = value\n            }\n        }\n        \n    },\n\n    // LIFE-CYCLE CALLBACKS:\n\n    onLoad () {\n        var Helper = require(\"helper\")\n        this.helper = new Helper()\n    },\n\n    start () {\n        this.node.on(\"touchstart\",this.onTouchStart,this)\n        this.node.on(\"touchmove\",this.onTouchMove,this)\n        this.node.on(\"touchend\",this.onTouchEnd,this)\n        //this.generateWalls()\n        var bulletsNode = cc.find(\"Canvas/bullets\")\n        this.bullets = bulletsNode.children\n        this.playerData = require(\"dataMgr\").playerData\n\n        this.maxHeart = this.playerData.maxHeart\n        this.heart = this.playerData.heart\n        this.heartForRetryCost = require(\"levelConfig\")[this.playerData.currentLevel.toString()].heartForRetryCost\n        require(\"networkMgr\").delegate = this\n\n        var wallsNode = cc.find(\"Canvas/walls\")\n        this.walls = wallsNode.children\n        this.targetsNum = cc.find(\"Canvas/targets\").children.length\n\n        var graphic = cc.find(\"Canvas/fillNodes\").getComponent(cc.Graphics)\n        var startPoint = null\n        var pointNodes = cc.find(\"Canvas/fillNodes\").children\n        if (pointNodes.length == 0) {\n            return\n        }\n        for (var index in pointNodes) {\n            var point = pointNodes[index]\n            if (startPoint == null) {\n                graphic.moveTo(point.x, point.y)\n                startPoint = point\n            }\n\n            graphic.lineTo(point.x, point.y)\n        }\n        graphic.close()\n        graphic.stroke()\n        graphic.fill()\n    },\n\n    // update (dt) {},\n\n    onTouchStart(event){\n        this.directionTryto = null\n        this.flag = true\n    },\n    onTouchMove(event) {\n        if (this.flag == false) {\n            return\n        }\n        var delta = event.getDelta()\n        var direction = this.getPossiableDirection(delta)\n\n        if (direction == -1) {\n            this.flag = false\n            return\n        }\n        if (this.directionTryto == null) {\n            this.directionTryto = direction\n        }\n        if (direction.equals(this.directionTryto) == false) {\n            this.flag = false\n            return\n        }\n\n        var startLocation = event.getStartLocation()\n        var disFromStart = cc.v2(event.getLocationX() - startLocation.x, event.getLocationY() - startLocation.y).mag()\n        if (disFromStart >= this.minDis) {\n            //valid move\n            this.flag = false\n            this.moveBullets(this.directionTryto)\n        }\n    },\n    onTouchEnd(event) {\n\n    },\n\n    onDestroy() {\n        this.node.off(\"touchstart\",this.onTouchStart,this)\n        this.node.off(\"touchmove\",this.onTouchMove,this)\n        this.node.off(\"touchend\",this.onTouchEnd,this)\n    },\n\n    getPossiableDirection(delta) {\n        if (this.isPossiableWithGivenDirection(delta,cc.v2(1,0)) == true) {\n            return cc.v2(1,0) //right\n        }\n        else if (this.isPossiableWithGivenDirection(delta,cc.v2(0,-1)) == true) {\n            return cc.v2(0,-1) //down\n        }\n        else if (this.isPossiableWithGivenDirection(delta,cc.v2(-1,0)) == true) {\n            return cc.v2(-1,0) //left\n        }\n        else if (this.isPossiableWithGivenDirection(delta,cc.v2(0,1)) == true) {\n            return cc.v2(0,1) //up\n        }\n        else {\n            return -1 //no direction match\n        }\n    },\n    \n    isPossiableWithGivenDirection(delta,givenDirection) {\n        var angle = delta.signAngle(givenDirection)\n        var degree = angle / Math.PI * 180\n        if (Math.abs(degree) <= this.maxOffsetDegree) {\n            return true\n        }\n        else {\n            return false\n        }\n    },\n    \n    moveBullets(direction) {\n        for (var index in this.bullets) {\n            if (this.bullets[index].getComponent(\"bulletMgr\").status != 0) {\n                return\n            }\n        }\n        var shadows = []\n        for (var index in this.bullets) {\n            var bullet = this.bullets[index]\n            var bulletMgr = bullet.getComponent(\"bulletMgr\")\n            var nearestWallInfo = bulletMgr.getNearestWallInfo(direction)\n            var shadowNode = {\n                x: nearestWallInfo.suitablePosition.x,\n                y: nearestWallInfo.suitablePosition.y,\n                width: bullet.width,\n                height: bullet.height,\n                dis: nearestWallInfo.dis,\n                originNode: bullet\n            }\n            shadows.push(shadowNode)\n        }\n\n        //resolve shadows\n\n        while(this.resolveShadows(shadows,direction) == false) {\n\n        }\n\n        for (var index in shadows) {\n            var shadowNode = shadows[index]\n            var originNode = shadowNode.originNode\n            originNode.getComponent(\"bulletMgr\").targetPosition = cc.v2(shadowNode.x, shadowNode.y)\n            originNode.getComponent(\"bulletMgr\").movingDirection = direction\n            originNode.getComponent(\"bulletMgr\").status = 1\n        }\n    },\n\n    onSuccess() {\n        cc.log(\"YOU WIN\")\n    },\n\n    resolveShadows(shadows,direction) {\n        for (var index in shadows) {\n            var oneShadow = shadows[index]\n            for (var i in shadows) {\n                var anotherShadow = shadows[i]\n                if (oneShadow == anotherShadow) {\n                    continue\n                }\n\n                var testResult = this._selectStaticShadowAndShaodwForResolved(oneShadow,anotherShadow,direction)\n                if (testResult != false) {\n                    var staticShadow = testResult.staticShadow\n                    var tempShadow = testResult.shadowForResolved\n                    \n                    var staticBorderLines = this.helper.getLinesOfOneNode(staticShadow)\n                    var staticLine = null\n                    var ray = this.helper.makeRay(cc.v2(staticShadow.x,staticShadow.y),1000,cc.v2(-direction.x,-direction.y))\n\n                    for(var k in staticBorderLines) {\n                        var line = staticBorderLines[k]\n                        var dis = this.helper.rayTest(ray,line)\n                        if (dis != false) {\n                            staticLine = line\n                            break\n                        }\n                    }\n                    var newPoint2 = this.helper.makeRay(staticLine.p2,1000,cc.v2(staticLine.p2.x - staticLine.p1.x, staticLine.p2.y - staticLine.p1.y)).p2\n                    var newPoint1 = this.helper.makeRay(staticLine.p1,1000,cc.v2(staticLine.p1.x - staticLine.p2.x, staticLine.p1.y - staticLine.p2.y)).p2\n                    staticLine = {\n                        p1: newPoint1,\n                        p2: newPoint2\n                    }\n                    var ray1 = this.helper.makeRay(tempShadow.originNode.position,3000,direction)\n                    var currentDistance = this.helper.rayTest(ray1,staticLine)\n                    var targetDis = this.helper.getDisToSelfBorder(tempShadow.originNode,direction) + tempShadow.originNode.getComponent(\"bulletMgr\").disFromBorder\n                    var suitablePosition = this.helper.getSuitablePoint(tempShadow.originNode.position,currentDistance,targetDis,direction)\n                    var updatedDis = cc.v2(suitablePosition.x - tempShadow.originNode.x, suitablePosition.y - tempShadow.originNode.y).mag()\n                    tempShadow.x = suitablePosition.x\n                    tempShadow.y = suitablePosition.y\n                    tempShadow.dis = updatedDis\n                    return false\n                }\n\n            }\n        }\n        return true\n    },\n    _selectStaticShadowAndShaodwForResolved(shadow1, shadow2, direction) {\n        var temp = function(s1,s2,d,target,givenType) {\n            var points = target.helper.getPointsOfOneNode(s1.originNode)\n            points[\"origin\"] = cc.v2(s1.originNode.x,s1.originNode.y)\n            for (var index in points) {\n                var ray = target.helper.makeRay(points[index],s1.dis,d)\n                var lines = null\n                if (givenType == 1) {\n                    lines = target.helper.getLinesOfOneNode(s2.originNode)\n                }\n                if (givenType == 2) {\n                    lines = target.helper.getLinesOfOneNode(s2)\n                }\n                for (var key in lines) {\n                    var line = lines[key]\n                    var result = target.helper.rayTest(ray,line)\n                    if (result != false) {\n\n                        return true\n                    }\n                }\n            }\n            return false\n        }\n\n        if (temp(shadow1,shadow2,direction,this,1) == true && temp(shadow1,shadow2,direction,this,2) == true) {\n            return {\n                staticShadow: shadow2,\n                shadowForResolved: shadow1\n            }\n        }\n\n        if (temp(shadow2,shadow1,direction,this,1) == true && temp(shadow2,shadow1,direction,this,2) == true) {\n            return {\n                staticShadow: shadow1,\n                shadowForResolved: shadow2\n            }\n        }\n\n        return false\n    },\n\n    generateWalls() {\n        var levelConfig = require(\"levelConfig\")\n        var currentLevel = 1\n\n        var config = levelConfig[currentLevel]\n        var wallsNode = cc.find(\"Canvas/walls\")\n        for (var index in config.wallPathes) {\n            var onePath = config.wallPathes[index]\n\n            var points = onePath.points\n            var realPoints = []\n            for (var i in points) {\n                var realPoint = null\n                if (i == 0) {\n                    realPoint = cc.v2(points[i].x, points[i].y)\n                }\n                else {\n                    var currentPoint = points[i]\n                    realPoint = cc.v2(realPoints[i - 1].x + currentPoint.x, realPoints[i - 1].y + currentPoint.y)\n                }\n                \n                realPoints.push(realPoint)\n            }\n            var lineWidth = onePath.lineWidth\n            var offset = onePath.offset\n            var wallNodes = []\n            var isClosed = onePath.isClosed\n            if (isClosed == true) {\n                var startPoint = realPoints[0]\n                realPoints.push(startPoint)\n            }\n            for (var i in realPoints) {\n                if (i == 0) {\n                    continue\n                }\n                \n                var node = cc.instantiate(this.linePrefab)\n                node.height = lineWidth\n                var directedLine = cc.v2(realPoints[i].x - realPoints[i - 1].x, realPoints[i].y - realPoints[i - 1].y)\n                node.width = directedLine.mag()\n    \n                var degree = directedLine.signAngle(cc.v2(1,0)) / Math.PI * 180\n                node.angle = -degree\n                node.x = realPoints[i].x - directedLine.x / 2\n                node.y = realPoints[i].y - directedLine.y / 2\n                var offsetDirection = directedLine.rotate(Math.PI / 2)\n                offsetDirection.normalizeSelf()\n                node.x += node.height / 2 * offsetDirection.x\n                node.y += node.height / 2 * offsetDirection.y\n\n                node.x += offset.x\n                node.y += offset.y\n                wallNodes.push(node)\n                wallsNode.addChild(node)                \n            }\n        }\n\n        var bulletConfig = config.bullets\n        var bulletsNode = cc.find(\"Canvas/bullets\")\n        for (var index in bulletConfig) {\n            var con = bulletConfig[index]\n            var bullet = cc.instantiate(this.bulletPrefab)\n            bullet.x = con.x\n            bullet.y = con.y\n            bullet.width = bullet.width * con.scale\n            bullet.height = bullet.height * con.scale\n            bulletsNode.addChild(bullet)\n        } \n    },\n\n\n    onClickRetryButton() {\n        var temp = this.heart - this.heartForRetryCost\n        if (temp < 0) {\n            return\n        }\n        \n        var msgObj = require(\"networkMgr\").makeMessageObj(\"dataModule\",\"commitMessageTyp\")\n        msgObj.message.id = this.playerData.playerId = this.playerData.id\n        msgObj.message.commitBody = {\n            heart: temp\n        }\n        var self = this\n        msgObj.successCallBack = function(xhr) {\n            var response = xhr.responseText\n            response = JSON.parse(response)\n\n            if (response.type == \"commitSuccess\") {\n                self.heart = temp\n                self.playerData.heart = temp\n                cc.director.loadScene(\"level001\")\n            }\n        }\n        this.retryButton.getComponent(cc.Button).interactable = false\n        require(\"networkMgr\").sendMessageByMsgObj(msgObj)\n    },\n    onAllRetryFailed() {\n        this.retryButton.getComponent(cc.Button).interactable = true\n    }\n\n});\n\n"]}