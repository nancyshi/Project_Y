{"version":3,"sources":["assets/scripts/singleInstanceSystems/advertisMgr.js"],"names":["AdvertisMgr","cc","Class","Component","properties","videoAd","delegate","wechatAdId","isReady","get","_isReady","set","value","showStatus","sdkbox","PluginAdMob","show","removeActivityNode","require","showNoti","showActivityNode","_showStatus","activityNode","isRewardSend","activityNodePrefab","reses","instantiate","bg","getChildByName","width","winSize","height","on","activity","tween","repeatForever","by","angle","start","director","getScene","addChild","parent","destroy","removeFromParent","onVideoAdEnd","onVideoAdNotEnd","defaultNoti","notificationSys","onVideoAdLoadError","err","console","log","onVideoAdShowError","initAds","sys","platform","WECHAT_GAME","self","wx","createRewardedVideoAd","adUnitId","onLoad","onError","onClose","res","isEnded","os","OS_IOS","OS_ANDROID","setListener","adViewDidReceiveAd","name","adViewDidFailToReceiveAdWithError","msg","adViewWillPresentScreen","audioEngine","pauseAll","adViewDidDismissScreen","cache","resumeAll","adViewWillDismissScreen","adViewWillLeaveApplication","reward","currency","amount","init","showVideoAd","load","then","sharedAdvertisMgr","module","exports"],"mappings":"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","sourceRoot":"/","sourcesContent":["// Learn cc.Class:\n//  - [Chinese] https://docs.cocos.com/creator/manual/zh/scripting/class.html\n//  - [English] http://docs.cocos2d-x.org/creator/manual/en/scripting/class.html\n// Learn Attribute:\n//  - [Chinese] https://docs.cocos.com/creator/manual/zh/scripting/reference/attributes.html\n//  - [English] http://docs.cocos2d-x.org/creator/manual/en/scripting/reference/attributes.html\n// Learn life-cycle callbacks:\n//  - [Chinese] https://docs.cocos.com/creator/manual/zh/scripting/life-cycle-callbacks.html\n//  - [English] https://www.cocos2d-x.org/docs/creator/manual/en/scripting/life-cycle-callbacks.html\n\nvar AdvertisMgr = cc.Class({\n    extends: cc.Component,\n\n    properties: {\n        // foo: {\n        //     // ATTRIBUTES:\n        //     default: null,        // The default value will be used only when the component attaching\n        //                           // to a node for the first time\n        //     type: cc.SpriteFrame, // optional, default is typeof default\n        //     serializable: true,   // optional, default is true\n        // },\n        // bar: {\n        //     get () {\n        //         return this._bar;\n        //     },\n        //     set (value) {\n        //         this._bar = value;\n        //     }\n        // },\n        videoAd: null,\n        delegate: null,\n\n        wechatAdId: \"xxxxx\",\n\n        isReady: {\n            get() {\n                return this._isReady\n            },\n            set(value) {\n                this._isReady = value\n                //1 = ok , 2 = loading 3 = erro\n                if (value == 1 && this.showStatus == 1) {\n                    sdkbox.PluginAdMob.show(\"rewarded\")\n                }\n                else if (value == 3 && this.showStatus == 1) {\n                    this.showStatus = 0\n                    this.removeActivityNode()\n                    require(\"notificationMgr\").showNoti(\"something wrong with ad system , retry later\")\n    \n                }\n\n                else if (value == 2 && this.showStatus == 1) {\n                    this.showActivityNode()\n                }\n            }\n        },\n\n        showStatus: {\n            get() {\n                return this._showStatus\n            },\n            set(value) {\n                this._showStatus = value\n                //0 = init 1 = will show 2 = showing\n\n            }\n        },\n\n        activityNode: null,\n\n        isRewardSend: false\n    },\n\n    showActivityNode() {\n        var activityNodePrefab = require(\"resMgr\").reses[\"activityNodePrefab\"]\n        var activityNode = cc.instantiate(activityNodePrefab)\n        var bg = activityNode.getChildByName(\"bg\")\n        bg.width = cc.winSize.width\n        bg.height = cc.winSize.height\n        bg.on(\"touchstart\",function(){})\n\n        var activity = activityNode.getChildByName(\"activity\")\n        cc.tween(activity)\n            .repeatForever(cc.tween()\n                    .by(2,{angle: 360})\n            )\n            .start()\n        this.activityNode = activityNode\n        cc.director.getScene().getChildByName(\"Canvas\").addChild(this.activityNode)\n    },\n\n    removeActivityNode() {\n        if (this.activityNode != null && this.activityNode.parent != null) {\n            this.activityNode.destroy()\n            this.activityNode.removeFromParent()\n            this.activityNode = null\n        }\n    },\n\n    onVideoAdEnd() {\n        if (this.delegate != null && typeof this.delegate.onVideoAdEnd == \"function\") {\n            this.delegate.onVideoAdEnd()\n        }\n    },\n    onVideoAdNotEnd(defaultNoti = true){\n        if (defaultNoti == true) {\n            var notificationSys = require(\"notificationMgr\")\n            notificationSys.showNoti(\"看完视频才能获得奖励哦~\")\n        }\n        if (this.delegate != null && typeof this.delegate.onVideoAdNotEnd == \"function\") {\n            this.delegate.onVideoAdNotEnd()\n        }\n    },\n    onVideoAdLoadError(err){\n        console.log(\"拉取广告失败\")\n        if (this.delegate != null && typeof this.delegate.onVideoAdLoadError == \"function\") {\n            this.delegate.onVideoAdLoadError(err)\n        }\n    },\n    onVideoAdShowError(err) {\n        if (this.delegate != null && typeof this.delegate.onVideoAdShowError == \"function\") {\n            this.delegate.onVideoAdShowError(err)\n        }\n    },\n    initAds(){\n        if (this.videoAd == null) {\n            if (cc.sys.platform == cc.sys.WECHAT_GAME) {\n                var self = this\n                this.videoAd = wx.createRewardedVideoAd({adUnitId: this.wechatAdId})\n                this.videoAd.onLoad(function(){\n                    console.log(\"拉取广告成功\")\n                })\n                this.videoAd.onError(function(err){\n                    self.onVideoAdLoadError(err)\n                })\n                this.videoAd.onClose(function(res){\n                    if (res && res.isEnded) {\n                        self.onVideoAdEnd()\n                    }\n                    else {\n                        self.onVideoAdNotEnd()\n                    }\n                })\n            }\n\n            else if (cc.sys.os == cc.sys.OS_IOS || cc.sys.os == cc.sys.OS_ANDROID) {\n                var self = this\n                sdkbox.PluginAdMob.setListener({\n                    adViewDidReceiveAd: function(name){\n                        self.isReady = 1\n                    },\n\n                    adViewDidFailToReceiveAdWithError: function(name,msg){\n                        self.isReady = 3\n                        self.onVideoAdLoadError(msg)\n                    },\n\n                    adViewWillPresentScreen: function(name) {\n                        self.removeActivityNode()\n                        self.showStatus = 2\n                        self.isRewardSend = false\n                        cc.audioEngine.pauseAll()\n                    },\n\n                    adViewDidDismissScreen: function(name) {\n                        self.showStatus = 0\n                        if (self.isRewardSend == false) {\n                            self.onVideoAdNotEnd(true)\n                        }\n                        self.isReady = 2\n                        sdkbox.PluginAdMob.cache(\"rewarded\")\n                        cc.audioEngine.resumeAll()\n                    },\n\n                    adViewWillDismissScreen: function(name) {\n                        \n                    },\n\n                    adViewWillLeaveApplication: function(name) {\n                        \n                    },\n                    reward: function(name,currency, amount) {\n                        self.isRewardSend = true\n                        self.onVideoAdEnd()\n                    }\n                })\n                this.isReady = 2\n                sdkbox.PluginAdMob.init()\n                sdkbox.PluginAdMob.cache(\"rewarded\")\n            }\n        }\n    },\n    showVideoAd() {\n\n        if (cc.sys.platform == cc.sys.WECHAT_GAME) {\n            var self = this\n            this.videoAd.load()\n            .then(function(){\n                self.videoAd.show()\n            })\n            .catch(function(err){\n                self.onVideoAdShowError(err)\n            })\n        }\n\n        else if (cc.sys.os == cc.sys.OS_ANDROID || cc.sys.os == cc.sys.OS_IOS) {\n            this.showStatus = 1\n            cc.log(this.isReady + \" : current isready\")\n            if (this.isReady == 1) {\n                this.showActivityNode()\n                sdkbox.PluginAdMob.show(\"rewarded\")\n            }\n            else if (this.isReady == 2) {\n                //just wait set event of isReady to 1\n                this.showActivityNode()\n            }\n            else if (this.isReady == 3) {\n                //reload once and then show\n                this.isReady = 2\n                sdkbox.PluginAdMob.cache(\"rewarded\")\n                //wait set event of isReady to 1\n            }\n        }\n    }\n});\n\nvar sharedAdvertisMgr = new AdvertisMgr()\nmodule.exports = sharedAdvertisMgr"]}