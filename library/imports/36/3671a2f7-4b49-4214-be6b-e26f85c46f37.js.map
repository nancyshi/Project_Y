{"version":3,"sources":["../../../../../assets/scripts/systems/assets/scripts/systems/signInSystem.js"],"names":["SignInSystem","cc","Class","extends","Component","properties","ui","physicalPowerAddNum","heartAddNum","addRateForAd","start","show","status","require","playerData","signInStatus","setupUiByStatus","others","getChildByName","scale","parent","currentScene","director","getScene","Canvas","addChild","active","tween","to","close","self","call","onVideoAdEnd","signIn","onVideoAdNotEnd","notiSys","notiStr","showNoti","onVideoAdShowError","err","console","log","onTimerReach","networkMgr","msgObj","makeMessageObj","message","playerId","id","successCallBack","xhr","response","responseText","JSON","parse","type","signInRefreshDelta","signInSysTimer","sendMessageByMsgObj","signInType","physicalPower","heart","onSignInSuccess","name","getComponent","indexOf","resMgr","instantiate","reses","ensureSysPrefab","ensureNodeMgr","canClose","ensureButtonWillAutoCloseUi","cancelButtonWillAutoCloseUi","desStr","desText","onCancleButtonClick","onEnsureButtonClick","advMgr","delegate","showVideoAd","toString","isExsistCancelButton","sharedSignSystem","module","exports"],"mappings":"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","file":"signInSystem.js","sourceRoot":"../../../../../assets/scripts/systems","sourcesContent":["// Learn cc.Class:\n//  - [Chinese] https://docs.cocos.com/creator/manual/zh/scripting/class.html\n//  - [English] http://docs.cocos2d-x.org/creator/manual/en/scripting/class.html\n// Learn Attribute:\n//  - [Chinese] https://docs.cocos.com/creator/manual/zh/scripting/reference/attributes.html\n//  - [English] http://docs.cocos2d-x.org/creator/manual/en/scripting/reference/attributes.html\n// Learn life-cycle callbacks:\n//  - [Chinese] https://docs.cocos.com/creator/manual/zh/scripting/life-cycle-callbacks.html\n//  - [English] https://www.cocos2d-x.org/docs/creator/manual/en/scripting/life-cycle-callbacks.html\n\nvar SignInSystem = cc.Class({\n    extends: cc.Component,\n\n    properties: {\n        // foo: {\n        //     // ATTRIBUTES:\n        //     default: null,        // The default value will be used only when the component attaching\n        //                           // to a node for the first time\n        //     type: cc.SpriteFrame, // optional, default is typeof default\n        //     serializable: true,   // optional, default is true\n        // },\n        // bar: {\n        //     get () {\n        //         return this._bar;\n        //     },\n        //     set (value) {\n        //         this._bar = value;\n        //     }\n        // },\n        ui: null,\n        physicalPowerAddNum: 10,\n        heartAddNum: 20,\n        addRateForAd: 2\n    },\n  \n\n    start () {\n\n    },\n    show() {\n        if (this.ui == null) {\n            var status = require(\"dataMgr\").playerData.signInStatus\n            this.setupUiByStatus(status)\n        }\n        var others = this.ui.getChildByName(\"others\")\n        others.scale = 0\n        if (this.ui.parent == null) {\n            var currentScene = cc.director.getScene()\n            var Canvas = currentScene.getChildByName(\"Canvas\")\n            Canvas.addChild(this.ui)\n        }\n        else {\n            this.ui.active = true\n        }\n\n        cc.tween(others)\n            .to(0.3,{scale: 1})\n            .start()\n    },\n    close() {\n        var others = this.ui.getChildByName(\"others\")\n        var self = this\n        cc.tween(others)\n            .to(0.3,{scale: 0})\n            .call(function(){\n                self.ui.active = false\n            })\n            .start()\n    },\n\n    onVideoAdEnd() {\n        if (signInStatus == 1) {\n            this.signIn(2)\n        }\n        else if (signInStatus == 2) {\n            this.signIn(3)\n        }\n    },\n    onVideoAdNotEnd(){\n        var notiSys = require(\"notificationMgr\")\n        var notiStr = \"看完广告视频才能获得奖励哦\"\n        notiSys.showNoti(notiStr)\n    },\n    onVideoAdShowError(err) {\n        console.log(\"wow, there are some problems for ad system\")\n        console.log(err)\n        var notiSys = require(\"notificationMgr\")\n        var notiStr = \"广告系统貌似有点问题，请稍后再试\"\n        notiSys.showNoti(notiStr)\n    },\n\n\n    \n    onTimerReach() {\n        var self = this\n        var networkMgr = require(\"networkMgr\")\n        var msgObj = networkMgr.makeMessageObj(\"signInModule\",\"refreshMessageType\")\n        msgObj.message.playerId = require(\"dataMgr\").playerData.id\n        msgObj.successCallBack = function(xhr) {\n            var response = xhr.responseText\n            response = JSON.parse(response)\n\n            if (response.type == \"success\") {\n                var signInRefreshDelta = response.signInRefreshDelta\n                require(\"dataMgr\").playerData.signInRefreshDelta = signInRefreshDelta\n                require(\"timerSystemsMgr\").signInSysTimer = signInRefreshDelta\n                require(\"dataMgr\").playerData.signInStatus = 1\n                self.setupUiByStatus(1)\n            }\n        }\n\n        networkMgr.sendMessageByMsgObj(msgObj)\n    },\n\n    signIn(signInType) {\n        var networkMgr = require(\"networkMgr\")\n        var msgObj = networkMgr.makeMessageObj(\"signInModule\",\"signInMessageType\")\n        msgObj.message.signInType = signInType\n        msgObj.message.playerId = require(\"dataMgr\").playerData.id\n        var self = this\n        msgObj.successCallBack = function(xhr) {\n            var response = xhr.responseText\n            response = JSON.parse(response)\n            \n            if (response.type == \"success\") {\n                var physicalPower = response.physicalPower\n                var heart = response.heart\n                self.onSignInSuccess(signInType,physicalPower,heart)\n            }\n        }\n\n        networkMgr.sendMessageByMsgObj(msgObj)\n    },\n\n    onSignInSuccess(signInType,physicalPower,heart) {\n        //signintype: \n        //1 = normal\n        //2 = ad\n        //3 = just ad\n        if (signInType == 1) {\n            require(\"dataMgr\").playerData.signInStatus = 2\n            this.setupUiByStatus(2)\n        }\n        else if (signInType == 2 || signInType == 3) {\n            require(\"dataMgr\").playerData.signInStatus = 3\n            this.setupUiByStatus(3)\n        }\n\n        require(\"dataMgr\").playerData.physicalPower = physicalPower\n        require(\"dataMgr\").playerData.heart = heart\n        var currentScene = cc.director.getScene()\n        if (currentScene.name == \"mainScene\") {\n            currentScene.getChildByName(\"Canvas\").getComponent(\"mainSceneMgr\").physicalPower = physicalPower\n            currentScene.getChildByName(\"Canvas\").getComponent(\"mainSceneMgr\").heart = heart\n        }\n        else if (currentScene.name.indexOf(\"level\") > -1) {\n            currentScene.getChildByName(\"Canvas\").getComponent(\"levelMgr\").heart = heart\n        }\n    },\n    setupUiByStatus(signInStatus) {\n        //1 is not sign\n        //2 is common sign\n        //3 is ad sign\n        \n        if (this.ui == null) {\n            var resMgr = require(\"resMgr\")\n            this.ui = cc.instantiate(resMgr.reses.ensureSysPrefab)\n        }\n        var ensureNodeMgr = this.ui.getComponent(\"ensureSystemNodeMgr\")\n        ensureNodeMgr.canClose = false\n        ensureNodeMgr.ensureButtonWillAutoCloseUi = false\n        ensureNodeMgr.cancelButtonWillAutoCloseUi = false\n\n        if (signInStatus == 1) {\n            var desStr = \"每日签到可以获得体力 * \" + this.physicalPowerAddNum + \", 金币 * \" + this.heartAddNum +\", \"\n            desStr = desStr + \"您是否愿意观看视频广告，获得双倍奖励？\"\n            ensureNodeMgr.desText = desStr\n            var self = this\n            ensureNodeMgr.onCancleButtonClick = function(){\n                self.close()\n                self.signIn(1)\n            }\n            ensureNodeMgr.onEnsureButtonClick = function(){\n                var advMgr = require(\"advertisMgr\")\n                advMgr.delegate = self\n                advMgr.showVideoAd()\n            }\n        }\n\n        else if (signInStatus == 2){\n            var desStr = \"您还可以观看视频广告获取体力 * \" + (this.addRateForAd * this.physicalPowerAddNum).toString()\n            desStr = desStr + \", \"\n            desStr = desStr + \"金币 * \" + (this.addRateForAd * this.heartAddNum).toString()\n            desStr = desStr + \"， 是否观看？\"\n            ensureNodeMgr.desText = desStr\n            var self = this\n\n            ensureNodeMgr.onEnsureButtonClick = function () {\n                var advMgr = require(\"advertisMgr\")\n                advMgr.delegate = self\n                advMgr.showVideoAd()\n            }\n            ensureNodeMgr.onCancleButtonClick = function() {\n                self.close()\n            }\n        }\n\n        else if (signInStatus == 3) {\n            var desStr = \"您今天已经签到过啦，明天再来吧~\"\n            ensureNodeMgr.desText = desStr\n            ensureNodeMgr.isExsistCancelButton = false\n            var self = this\n            ensureNodeMgr.onEnsureButtonClick = function () {\n                self.close()\n            }\n        }\n\n    }\n\n    // update (dt) {},\n});\n\nvar sharedSignSystem = new SignInSystem()\nmodule.exports = sharedSignSystem"]}