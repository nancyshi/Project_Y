{"version":3,"sources":["networkMgr.js"],"names":["Networkmgr","cc","Class","extends","Component","properties","delegate","retryDelta","maxRetryTime","retryWaitingNode","retryAction","start","sendMessage","msg","port","ip","suffix","successCallBack","xhr","XMLHttpRequest","onreadystatechange","readyState","status","url","toString","open","send","makeMessageObj","moduleName","messageTypeName","gloableConfig","require","netWorkMessageConfigs","moduleObj","basicIp","basicPort","message","obj","error","sendMessageByMsgObj","msgObj","self","retryingFlag","retryResult","msgForSend","JSON","stringify","onerror","log","currentRetryTime","undefined","retry","destroy","removeFromParent","unscheduleAllCallbacks","currentScene","director","getScene","name","mgr","getChildByName","getComponent","onAllRetryFailed","loader","loadRes","err","res","node","instantiate","bg","width","winSize","height","on","ensureButtonNode","loadScene","addChild","schedule","ontimeout","onabort","startHeartBeat","messageObj","playerId","playerData","id","response","responseText","parse","type","messages","index","oneMessage","mailId","timeStamp","tag","mail","mails","sharedMgr","module","exports"],"mappings":"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","file":"networkMgr.js","sourceRoot":"../../../../../assets/scripts/libs","sourcesContent":["// Learn cc.Class:\n//  - [Chinese] https://docs.cocos.com/creator/manual/zh/scripting/class.html\n//  - [English] http://docs.cocos2d-x.org/creator/manual/en/scripting/class.html\n// Learn Attribute:\n//  - [Chinese] https://docs.cocos.com/creator/manual/zh/scripting/reference/attributes.html\n//  - [English] http://docs.cocos2d-x.org/creator/manual/en/scripting/reference/attributes.html\n// Learn life-cycle callbacks:\n//  - [Chinese] https://docs.cocos.com/creator/manual/zh/scripting/life-cycle-callbacks.html\n//  - [English] https://www.cocos2d-x.org/docs/creator/manual/en/scripting/life-cycle-callbacks.html\n\nvar Networkmgr = cc.Class({\n    extends: cc.Component,\n    properties: {\n        // foo: {\n        //     // ATTRIBUTES:\n        //     default: null,        // The default value will be used only when the component attaching\n        //                           // to a node for the first time\n        //     type: cc.SpriteFrame, // optional, default is typeof default\n        //     serializable: true,   // optional, default is true\n        // },\n        // bar: {\n        //     get () {\n        //         return this._bar;\n        //     },\n        //     set (value) {\n        //         this._bar = value;\n        //     }\n        // },\n        delegate: null,\n\n        retryDelta: 1.5,\n        maxRetryTime: 3,\n\n        retryWaitingNode: null,\n        retryAction: null\n    },\n\n    // LIFE-CYCLE CALLBACKS:\n\n    // onLoad () {},\n\n    start () {\n\n    },\n\n    // update (dt) {},\n\n    sendMessage(msg,port,ip,suffix,successCallBack) {\n        var xhr = new XMLHttpRequest()\n        xhr.onreadystatechange = function() {\n            if (xhr.readyState == 4 && (xhr.status >= 200 && xhr.status < 400)) {\n                successCallBack(xhr)\n            }\n        }\n        var url = \"http://\" + ip + \":\" + port.toString() +\"/\" + suffix.toString()\n        xhr.open(\"POST\",url)\n        xhr.send(msg)\n    },\n\n    makeMessageObj(moduleName, messageTypeName) {\n        var gloableConfig = require(\"gloableConfig\")\n        \n        var netWorkMessageConfigs = gloableConfig.netWorkMessageConfigs\n        var moduleObj = netWorkMessageConfigs[moduleName]\n        \n        if (moduleObj != null) {\n            var ip = gloableConfig.basicIp\n            var port = gloableConfig.basicPort\n            if (moduleObj.ip != null) {\n                ip = moduleObj.ip\n            }\n            if (moduleObj.port != null) {\n                port = moduleObj.port\n            }\n\n            var suffix = moduleObj.suffix\n            \n            var message = moduleObj[messageTypeName]\n            var successCallBack = function(xhr){}\n            var obj = {\n                ip: ip,\n                port: port,\n                suffix: suffix,\n                message: message,\n                successCallBack: successCallBack\n            }\n            return obj\n        }\n        else {\n            cc.error(\"no such module name of \" + moduleName)\n            return null\n        }\n    },\n\n    sendMessageByMsgObj(msgObj) {\n        var url = \"https://\" + msgObj.ip + \":\" + msgObj.port.toString() + \"/\" + msgObj.suffix\n        var xhr = null\n        xhr = new XMLHttpRequest()\n        var self = this\n        xhr.onreadystatechange = function() {\n            if (xhr.readyState == 4 && (xhr.status >= 200 && xhr.status < 400)) {\n                msgObj.successCallBack(xhr)\n                if (self.retryingFlag == true) {\n                    self.retryResult = true\n                }\n            }\n        }\n        var msgForSend = JSON.stringify(msgObj.message)\n        xhr.onerror = function(){\n            cc.log(\"err\")\n            if (self.retryAction == null) {\n                self.retryAction = function(){\n                    xhr.send(msgForSend)\n                    xhr.currentRetryTime += 1\n                }\n            }\n\n            if (xhr.currentRetryTime == null || xhr.currentRetryTime == undefined) {\n                xhr.currentRetryTime = 0\n            }\n            var retry = function(xhr){\n                cc.log(\"retry\",xhr.currentRetryTime)\n                if (xhr.currentRetryTime > self.maxRetryTime) {\n                    self.retryWaitingNode.destroy()\n                    self.retryWaitingNode.removeFromParent()\n                    self.retryWaitingNode = null\n                    self.retryAction = null\n                    self.unscheduleAllCallbacks()\n\n                    //do something else\n                    var currentScene = cc.director.getScene()\n                    if (currentScene.name == \"loginScene\") {\n                        var mgr = currentScene.getChildByName(\"Canvas\").getComponent(\"loginSceneMgr\")\n                        mgr.onAllRetryFailed()\n                    }\n                    else {\n                        cc.loader.loadRes(\"prefabs/backToLoginScene\",function(err,res){\n                            var node = cc.instantiate(res)\n                            var bg = node.getChildByName(\"bg\")\n                            bg.width = cc.winSize.width\n                            bg.height = cc.winSize.height\n                            bg.on(\"touchstart\",function(){})\n\n                            var ensureButtonNode = node.getChildByName(\"others\").getChildByName(\"ensureButton\")\n                            ensureButtonNode.on(\"click\",function(){\n                                cc.director.loadScene(\"loginScene\")\n                            })\n\n                            cc.director.getScene().getChildByName(\"Canvas\").addChild(node)\n                        })  \n                    }\n                }\n                else if (xhr.currentRetryTime == 0) {\n                    cc.director.getScene().getChildByName(\"Canvas\").addChild(self.retryWaitingNode)\n                    self.schedule(self.retryAction,self.retryDelta)\n                }\n            \n            }\n            if (self.retryWaitingNode == null) {\n                cc.loader.loadRes(\"prefabs/retryWaitingNode\",function(err,res){\n                    var node = cc.instantiate(res)\n                    var bg = node.getChildByName(\"bg\")\n                    bg.width = cc.winSize.width\n                    bg.height = cc.winSize.height\n                    bg.on(\"touchstart\",function(){})\n\n                    self.retryWaitingNode = node\n                    retry(xhr)\n                })\n            }\n            else {\n                retry(xhr)\n            }\n            \n        }\n        xhr.ontimeout = function(){\n            cc.log(\"time out!!!\")\n        }\n        xhr.onabort = function(){\n            cc.log(\"abord\")\n        }\n        if (xhr.readyState == 0) {\n            xhr.open(\"POST\",url)\n        }\n        xhr.send(msgForSend)\n    },\n\n    onAllRetryFailed() {\n\n    },\n\n    startHeartBeat() {\n        var messageObj = this.makeMessageObj(\"longConnectModule\",\"heartBeatMessageType\")\n        messageObj.message.playerId = require(\"dataMgr\").playerData.id\n        messageObj.successCallBack = function(xhr) {\n            var response = xhr.responseText\n            response = JSON.parse(response)\n            if (response.type == \"message\") {\n                var messages = response.messages\n                for (var index in messages) {\n                    var oneMessage = messages[index]\n                    if (oneMessage.type == \"mailSysSendMail\") {\n                        var mailId = oneMessage.mailId\n                        var timeStamp = oneMessage.timeStamp\n                        var tag = oneMessage.tag\n                        var mail = {\n                            \"status\": 0,\n                            \"tag\": tag,\n                            \"timeStamp\": timeStamp,\n                            \"selectedOptionIndex\": -1\n                        }\n                        require(\"dataMgr\").playerData.mails[mailId] = mail\n                    }\n                }\n            }\n        }\n        //this.sendMessageByMsgObj(messageObj,true)\n        this.schedule(function(){\n            this.sendMessageByMsgObj(messageObj)\n        }, 60)\n    }\n});\n\n\nvar sharedMgr = new Networkmgr()\nmodule.exports = sharedMgr\n"]}