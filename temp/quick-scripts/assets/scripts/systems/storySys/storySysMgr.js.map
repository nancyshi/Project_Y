{"version":3,"sources":["storySysMgr.js"],"names":["cc","Class","extends","Component","properties","contentNode","Node","storyTextNodePrefab","Prefab","disBetweenStoryTextNodes","continueLabelNode","completeButtonNode","startDelayTime","storyId","storyTextNodes","status","get","_status","set","value","active","log","header","footer","sectionDis","totalHeight","totalTextNodeNum","currentNum","textIds","onLoad","self","bg","node","getChildByName","width","winSize","height","monitoredNode","on","str","require","getTextByIdAndLanguageType","_showOneStoryText","completeStory","getComponent","Label","string","tween","repeatForever","to","opacity","start","scrollContainer","y","tempHeight","showStory","storyConfig","key","toString","config","length","delay","call","networkMgr","messageObj","makeMessageObj","message","playerId","playerData","id","successCallBack","xhr","response","responseText","JSON","parse","type","storySysId","closeSystem","Button","interactable","sendMessageByMsgObj","instantiate","_forceUpdateRenderData","ScrollView","vertical","addChild","onWillOpend","givenStoryId"],"mappings":"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","file":"storySysMgr.js","sourceRoot":"../../../../../../assets/scripts/systems/storySys","sourcesContent":["// Learn cc.Class:\n//  - [Chinese] https://docs.cocos.com/creator/manual/zh/scripting/class.html\n//  - [English] http://docs.cocos2d-x.org/creator/manual/en/scripting/class.html\n// Learn Attribute:\n//  - [Chinese] https://docs.cocos.com/creator/manual/zh/scripting/reference/attributes.html\n//  - [English] http://docs.cocos2d-x.org/creator/manual/en/scripting/reference/attributes.html\n// Learn life-cycle callbacks:\n//  - [Chinese] https://docs.cocos.com/creator/manual/zh/scripting/life-cycle-callbacks.html\n//  - [English] https://www.cocos2d-x.org/docs/creator/manual/en/scripting/life-cycle-callbacks.html\n\ncc.Class({\n    extends: cc.Component,\n\n    properties: {\n        // foo: {\n        //     // ATTRIBUTES:\n        //     default: null,        // The default value will be used only when the component attaching\n        //                           // to a node for the first time\n        //     type: cc.SpriteFrame, // optional, default is typeof default\n        //     serializable: true,   // optional, default is true\n        // },\n        // bar: {\n        //     get () {\n        //         return this._bar;\n        //     },\n        //     set (value) {\n        //         this._bar = value;\n        //     }\n        // },\n        contentNode: cc.Node,\n        storyTextNodePrefab: cc.Prefab,\n        disBetweenStoryTextNodes: 50,\n        continueLabelNode: cc.Node,\n        completeButtonNode: cc.Node,\n        startDelayTime: 1,\n        storyId: null,\n\n        storyTextNodes: [],\n        status: {\n            get() {\n                return this._status\n            },\n            set(value) {\n                this._status = value\n                // 1 = start showing a node\n                // 2 = showing complete , wating for tap to next\n                // 3 = all nodes showing complete , wating for click button to complete\n                switch(value) {\n                    case 1:\n                        this.continueLabelNode.active = false\n                        this.completeButtonNode.active = false\n                        break\n                    case 2:\n                        this.continueLabelNode.active = true\n                        this.completeButtonNode.active = false\n                        break\n                    case 3:\n                        this.continueLabelNode.active = false\n                        this.completeButtonNode.active = true\n                        break\n                    default:\n                        cc.log(\"STORYSYSMGR: WRONG STATUS VALUE PROVIDED\")\n                }\n            }\n        },\n        header: 100,\n        footer: 100,\n        sectionDis: 50,\n\n        totalHeight: 0,\n        totalTextNodeNum: null,\n        currentNum: null,\n        textIds: null\n    },\n\n    // LIFE-CYCLE CALLBACKS:\n\n    onLoad () {\n        var self = this\n        var bg = this.node.getChildByName(\"bg\")\n        bg.width = cc.winSize.width\n        bg.height = cc.winSize.height\n        this.node.width = bg.width\n        this.node.height = bg.height\n        var monitoredNode = this.contentNode.getChildByName(\"tapMonitoredNode\")\n        monitoredNode.width = bg.width\n        monitoredNode.height = bg.height\n        //cc.log(bg.width,bg.height)\n        monitoredNode.on(\"touchstart\",function(){\n            if (self.status == 2) {\n                self.currentNum += 1\n                var str = require(\"textConfig\").getTextByIdAndLanguageType(self.textIds[self.currentNum - 1])\n                self._showOneStoryText(str)\n            }\n        },this)\n        this.completeButtonNode.on(\"click\",function(){\n            if (self.status == 3) {\n                self.completeStory()\n            }\n        })\n        this.completeButtonNode.getChildByName(\"New Label\").getComponent(cc.Label).string = require(\"textConfig\").getTextByIdAndLanguageType(122)\n\n        cc.tween(this.continueLabelNode)\n            .repeatForever(cc.tween()\n                    .to(0.3, {opacity: 0})\n                    .to(0.3, {opacity: 255})    \n            )\n            .start()\n\n        var scrollContainer = this.node.getChildByName(\"scrollContainer\")\n        scrollContainer.y = bg.height / 2 - this.footer\n        this.continueLabelNode.y = -bg.height / 2 + this.footer + this.completeButtonNode.height / 2\n        this.completeButtonNode.y = -bg.height / 2 + this.footer + this.completeButtonNode.height / 2\n\n        var tempHeight = bg.height - this.header - this.footer - this.completeButtonNode.height - this.sectionDis\n        scrollContainer.height = tempHeight\n        scrollContainer.getChildByName(\"view\").height = tempHeight\n        this.contentNode.height = tempHeight\n    },\n\n    start () {\n\n        this.showStory()\n    },\n\n    showStory() {\n        if (this.storyId == null) {\n            cc.log(\"NO STORY ID PROVIDED\")\n            return\n        }\n        var storyConfig = require(\"storyConfig\")\n        var key = \"story_\" + this.storyId.toString()\n        var config = storyConfig[key]\n        var textIds = config.textIds\n        this.textIds = textIds\n        this.totalTextNodeNum = textIds.length\n        \n        this.currentNum = 1\n        var str = require(\"textConfig\").getTextByIdAndLanguageType(textIds[0])\n        var self = this\n        cc.tween(this.node)\n            .delay(self.startDelayTime)\n            .call(function(){\n                self._showOneStoryText(str)\n            })\n            .start()\n    },\n\n    completeStory() {\n        var networkMgr = require(\"networkMgr\")\n        var messageObj = networkMgr.makeMessageObj(\"storyModule\",\"completeCurrentMessageType\")\n        messageObj.message.playerId = require(\"dataMgr\").playerData.id\n        messageObj.successCallBack = function(xhr) {\n            var response = xhr.responseText\n            response = JSON.parse(response)\n            if (response.type == \"success\") {\n                var storyId = response.storyId\n                require(\"dataMgr\").playerData.storySysId = storyId\n                require(\"systemsMgr\").closeSystem(\"storySys\",3)\n            }\n        }\n        \n        this.completeButtonNode.getComponent(cc.Button).interactable = false\n        networkMgr.sendMessageByMsgObj(messageObj)\n    },\n\n    _showOneStoryText(str) {\n        this.status = 1\n        var node = cc.instantiate(this.storyTextNodePrefab)\n        node.getComponent(cc.Label).string = str\n        node.getComponent(cc.Label)._forceUpdateRenderData()\n        node.y = -this.totalHeight\n\n        this.totalHeight += node.height + this.disBetweenStoryTextNodes\n        if (this.contentNode.height < this.totalHeight) {\n            this.contentNode.height = this.totalHeight\n            this.node.getChildByName(\"scrollContainer\").getComponent(cc.ScrollView).vertical = true\n        }\n        node.opacity = 0\n        this.contentNode.addChild(node)\n        var self = this\n        cc.tween(node)\n            .to(0.5,{opacity: 255})\n            .call(function(){\n                if (self.currentNum == self.totalTextNodeNum) {\n                    self.status = 3\n                }\n                else {\n                    self.status = 2\n                }\n            })\n            .start()\n    },\n\n    onWillOpend(givenStoryId) {\n        this.storyId = givenStoryId\n    }\n    // update (dt) {},\n});\n"]}