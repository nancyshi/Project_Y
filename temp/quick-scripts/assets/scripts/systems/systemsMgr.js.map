{"version":3,"sources":["systemsMgr.js"],"names":["SystemsMgr","cc","Class","extends","Component","properties","welfarySys","get","_welfarySys","setupSysProperty","systems","signInSys","_signInSys","addPropertyNumSys","_addPropertyNumSys","mailSys","_mailSys","_systems","givenPrefabName","givenName","givenMgrName","givenSysProperty","uiPrefab","require","reses","opendNode","name","mgrName","showSystem","givenSysName","para","givenSys","getSysBySysName","log","ui","instantiate","mgr","getComponent","onWillOpend","others","getChildByName","bg","width","winSize","height","on","director","getScene","addChild","scale","tween","to","start","closeSystem","call","destroy","systemsGloableDataMonitored","key","value","mailSysGloableMonitored","onReachCondition","givenTag","givenMailId","networkMgr","messageObj","makeMessageObj","message","playerId","playerData","id","tag","mailId","successCallBack","xhr","response","responseText","JSON","parse","type","mailConditionIndex","newMail","mail","mails","sendMessageByMsgObj","mailSysConfig","tags","Object","keys","index","oneTag","conditionIndex","element","conditions","conditionType","conditionPara","indexOf","levelId","slice","parseInt","minStepNum","mailSysGloableSendOneMail","complete","delay","systemsMgr","module","exports"],"mappings":"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","file":"systemsMgr.js","sourceRoot":"../../../../../assets/scripts/systems","sourcesContent":["// Learn cc.Class:\n//  - [Chinese] https://docs.cocos.com/creator/manual/zh/scripting/class.html\n//  - [English] http://docs.cocos2d-x.org/creator/manual/en/scripting/class.html\n// Learn Attribute:\n//  - [Chinese] https://docs.cocos.com/creator/manual/zh/scripting/reference/attributes.html\n//  - [English] http://docs.cocos2d-x.org/creator/manual/en/scripting/reference/attributes.html\n// Learn life-cycle callbacks:\n//  - [Chinese] https://docs.cocos.com/creator/manual/zh/scripting/life-cycle-callbacks.html\n//  - [English] https://www.cocos2d-x.org/docs/creator/manual/en/scripting/life-cycle-callbacks.html\n\n\n//a typical system will have an ui , which will be created by a prefab\n//other system will not be contained by here, such as notificaition system\nvar SystemsMgr = cc.Class({\n    extends: cc.Component,\n\n    properties: {\n        welfarySys: {\n            get() {\n                if (this._welfarySys == null) {\n                    this._welfarySys = this.setupSysProperty(\"welfarySysPrefab\",\"welfarySys\",\"welfarySysMgr\")\n                    this.systems[\"welfarySys\"] = this._welfarySys\n                }\n                return this._welfarySys\n            }\n        },\n        signInSys: {\n            get() {\n                if (this._signInSys == null) {\n                    this._signInSys = this.setupSysProperty(\"signInSysPrefab\", \"signInSys\",\"signInSysMgr\")\n                    this.systems[\"signInSys\"] = this._signInSys\n                }\n                return this._signInSys\n            }\n        },\n\n        addPropertyNumSys: {\n            get() {\n                if (this._addPropertyNumSys == null) {\n                    this._addPropertyNumSys = this.setupSysProperty(\"addPropertyNumSysPrefab\",\"addPropertyNumSys\",\"addPropertyNumSysMgr\")\n                    this.systems[\"addPropertyNumSys\"] = this._addPropertyNumSys\n                }\n                return this._addPropertyNumSys\n            }\n        },\n\n        mailSys: {\n            get() {\n                if (this._mailSys == null) {\n                    this._mailSys = this.setupSysProperty(\"mailSysPrefab\",\"mailSys\",\"mailSysMgr\")\n                    this.systems[\"mailSys\"] = this._mailSys\n                }\n                return this._mailSys\n            }\n        },\n\n        systems: {\n            get() {\n                if (this._systems == null) {\n                    this._systems = {}\n                }\n                return this._systems\n            }\n        }\n    },\n\n    setupSysProperty(givenPrefabName, givenName, givenMgrName) {\n        var givenSysProperty = {}\n        givenSysProperty.uiPrefab = require(\"resMgr\").reses[givenPrefabName]\n        givenSysProperty.opendNode = null\n        givenSysProperty.name = givenName\n        givenSysProperty.mgrName = givenMgrName\n        return givenSysProperty\n    },\n\n    showSystem(givenSysName, para = null) {\n        var givenSys = this.getSysBySysName(givenSysName)\n        if (givenSys.opendNode != null) {\n            cc.log(\"this sys has been opend , can't reopen: \" + givenSys.name)\n            return\n        }\n        var ui = cc.instantiate(givenSys.uiPrefab)\n        var mgrName = this.systems[givenSys.name].mgrName\n        var mgr = ui.getComponent(mgrName)\n        if (mgr != null && typeof mgr.onWillOpend === \"function\") {\n            mgr.onWillOpend(para)\n        }\n        var others = ui.getChildByName(\"others\")\n        var bg = ui.getChildByName(\"bg\")\n        if (bg != null) {\n            bg.width = cc.winSize.width\n            bg.height = cc.winSize.height\n            bg.on(\"touchstart\",function(){})\n        }\n        cc.director.getScene().getChildByName(\"Canvas\").addChild(ui)\n        givenSys.opendNode = ui\n        if (others != null) {\n            others.scale = 0\n            cc.tween(others)\n                .to(0.3,{scale: 1})\n                .start()\n        }\n        else {\n            ui.scale = 0\n            cc.tween(ui)\n                .to(0.3,{scale: 1})\n                .start()\n        }\n    },\n\n    closeSystem(givenSysName) {\n        var givenSys = this.getSysBySysName(givenSysName)\n        var opendNode = givenSys.opendNode\n        if (opendNode == null) {\n            cc.log(givenSys.name + \"has not been opend, no need to colse\")\n            return\n        }\n\n        var others = opendNode.getChildByName(\"others\")\n        if (others != null) {\n            cc.tween(others)\n                .to(0.3, {scale: 0})\n                .call(function(){\n                    opendNode.destroy()\n                    givenSys.opendNode = null\n                })\n                .start()\n        }\n        else {\n            cc.tween(opendNode)\n                .to(0.3, {scale: 0})\n                .call(function(){\n                    opendNode.destroy()\n                    givenSys.opendNode = null\n                })\n        }\n    },\n\n    getSysBySysName(givenSysName) {\n        switch(givenSysName){\n            case \"welfarySys\" :\n                return this.welfarySys\n            case \"signInSys\":\n                return this.signInSys\n            case \"addPropertyNumSys\":\n                return this.addPropertyNumSys\n            case \"mailSys\":\n                return this.mailSys\n            default:\n                cc.log(\"no such sys\")\n                return false\n        }\n    },\n\n    systemsGloableDataMonitored(key,value) {\n        //mailSys\n            //monitored whether reach mail condition\n        this.mailSysGloableMonitored(key,value)\n    },\n\n\n    mailSysGloableMonitored(key,value) {\n        \n        var onReachCondition = function(givenTag,givenMailId) {\n            var networkMgr = require(\"networkMgr\")\n            var messageObj = networkMgr.makeMessageObj(\"mailModule\",\"reachConditionMessageType\")\n            messageObj.message.playerId = require(\"dataMgr\").playerData.id\n            messageObj.message.tag = givenTag\n            messageObj.message.mailId = givenMailId\n            messageObj.successCallBack = function(xhr) {\n                var response = xhr.responseText\n                response = JSON.parse(response)\n                if (response.type == \"success\") {\n                    require(\"dataMgr\").playerData.mailConditionIndex[givenTag] += 1\n                    var newMail = response.mail\n                    require(\"dataMgr\").playerData.mails[givenMailId] = newMail\n                }\n            }\n            networkMgr.sendMessageByMsgObj(messageObj)\n        }\n        var mailSysConfig = require(\"mailSysConfig\")\n        var tags = Object.keys(mailSysConfig)\n        for (var index in tags) {\n            var oneTag = tags[index]\n            var conditionIndex = require(\"dataMgr\").playerData.mailConditionIndex[oneTag]\n            var element = mailSysConfig[oneTag].conditions[conditionIndex]\n            var conditionType = element.conditionType\n            var conditionPara = element.conditionPara\n\n            if (conditionType == 1) {\n                //reach given level id\n                if (key != \"currentLevel\") {\n                    continue\n                }\n                \n                if (value == conditionPara) {\n                    var mailId = element.mailId\n                    onReachCondition(oneTag,mailId)\n                }\n            }\n            else if (conditionType == 2) {\n                //min step num of given level less than a value\n                if (key.indexOf(\"minStep_level_\") == -1) {\n                    continue\n                }\n\n                var levelId = key.slice(14)\n                if (parseInt(levelId) == conditionPara.levelId){\n                    if (value <= conditionPara.minStepNum) {\n                        var mailId = element.mailId\n                        onReachCondition(oneTag,mailId)\n                    }\n                }\n            }\n        }\n    },\n\n    mailSysGloableSendOneMail(givenMailId,givenTag,complete = function(){},delay = 0) {\n        var networkMgr = require(\"networkMgr\")\n        var messageObj = networkMgr.makeMessageObj(\"mailModule\",\"sendMailMessageType\")\n        messageObj.message.playerId = require(\"dataMgr\").playerData.id\n        messageObj.message.mailId = givenMailId\n        messageObj.message.tag = givenTag\n        messageObj.message.delay = delay\n        messageObj.successCallBack = function(xhr) {\n            var response = xhr.responseText\n            response = JSON.parse(response)\n            if (response.type == \"success\") {\n                complete()\n            }\n        }\n        networkMgr.sendMessageByMsgObj(messageObj)\n    }\n    // update (dt) {},\n});\n\nvar systemsMgr = new SystemsMgr()\nmodule.exports = systemsMgr"]}