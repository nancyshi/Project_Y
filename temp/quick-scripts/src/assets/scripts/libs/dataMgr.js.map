{"version":3,"sources":["assets/scripts/libs/dataMgr.js"],"names":["dataMgr","cc","Class","Component","properties","playerData","get","_playerData","set","value","Proxy","dataMonitoredProxyHandler","onPlayerDataUpdated","_dataMonitoredProxyHandler","handler","target","key","globalRedPointMgr","require","setupRedPoints","systems","systemsGloableDataMonitored","k","oneSys","opendNode","mgr","getComponent","mgrName","dataMonitored","currentScene","director","getScene","name","getChildByName","delegate","updatePlayerDataFromServer","playerId","networkMgr","msgObj","makeMessageObj","message","self","successCallBack","xhr","response","responseText","JSON","parse","type","sendMessageByMsgObj","log","stringify","timerSystemsMgr","initSetup","lunch","loginSceneMgr","commitPlayerDataToServer","dataForCommit","id","commitBody","shareDataMgr","module","exports"],"mappings":"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","sourceRoot":"/","sourcesContent":["// Learn cc.Class:\n//  - [Chinese] https://docs.cocos.com/creator/manual/zh/scripting/class.html\n//  - [English] http://docs.cocos2d-x.org/creator/manual/en/scripting/class.html\n// Learn Attribute:\n//  - [Chinese] https://docs.cocos.com/creator/manual/zh/scripting/reference/attributes.html\n//  - [English] http://docs.cocos2d-x.org/creator/manual/en/scripting/reference/attributes.html\n// Learn life-cycle callbacks:\n//  - [Chinese] https://docs.cocos.com/creator/manual/zh/scripting/life-cycle-callbacks.html\n//  - [English] https://www.cocos2d-x.org/docs/creator/manual/en/scripting/life-cycle-callbacks.html\n\nvar dataMgr = cc.Class({\n    \n    extends: cc.Component,\n    properties: {\n\n        playerData: {\n            get() {\n                return this._playerData\n            },\n            set(value) {\n                this._playerData = new Proxy(value,this.dataMonitoredProxyHandler)\n                this.onPlayerDataUpdated()\n                //do something else\n            }\n        },\n\n        dataMonitoredProxyHandler: {\n            get() {\n                if (this._dataMonitoredProxyHandler == null) {\n                    var handler = {\n                        get(target, key) {\n                            if (typeof target[key] === \"object\") {\n                                return new Proxy(target[key],handler)\n                            }\n                            return target[key]\n                        },\n                        set(target, key, value) {\n                            target[key] = value\n                            var globalRedPointMgr = require(\"globalRedPointMgr\")\n                            globalRedPointMgr.setupRedPoints()\n                            var systems = require(\"systemsMgr\").systems\n                            require(\"systemsMgr\").systemsGloableDataMonitored(key,value)\n                            for (var k in systems) {\n                                var oneSys = systems[k]\n                                if (oneSys.opendNode != null) {\n                                    var mgr = oneSys.opendNode.getComponent(oneSys.mgrName)\n                                    if (mgr != null && typeof mgr.dataMonitored === \"function\") {\n                                        mgr.dataMonitored(key,value)\n                                    }\n                                }\n                            }\n\n                            var currentScene = cc.director.getScene()\n                            var mgrName = null\n                            switch(currentScene.name) {\n                                case \"mainScene\":\n                                    mgrName = \"mainSceneMgr\"\n                                    break\n                                case \"levelScene\":\n                                    mgrName = \"levelMgr\"\n                                    break\n                            }\n                            if (mgrName != null) {\n                                var mgr = currentScene.getChildByName(\"Canvas\").getComponent(mgrName)\n                                if (mgr != null && typeof mgr.dataMonitored === \"function\") {\n                                    mgr.dataMonitored(key,value)\n                                }\n                            }\n                            return true\n                        }\n                    }\n                    this._dataMonitoredProxyHandler = handler\n                }\n\n                return this._dataMonitoredProxyHandler\n            }\n        },\n        \n        delegate: null\n        \n    },\n\n    updatePlayerDataFromServer(playerId) {\n\n        var networkMgr = require(\"networkMgr\")\n        var msgObj = networkMgr.makeMessageObj(\"dataModule\",\"queryMessageType\")\n        msgObj.message.playerId = playerId\n        var self = this\n        msgObj.successCallBack = function(xhr) {\n            var response = xhr.responseText\n            response = JSON.parse(response)  \n            if (response.type == \"success\") {\n                self.playerData = response.playerData\n            }\n            else {\n                //do something for erros\n            }\n        }\n        networkMgr.sendMessageByMsgObj(msgObj)\n    },\n    onPlayerDataUpdated () {\n        cc.log(\"now player data is \" + JSON.stringify(this.playerData))\n        var timerSystemsMgr = require(\"timerSystemsMgr\")\n        timerSystemsMgr.initSetup()\n        timerSystemsMgr.lunch()\n        if (cc.director.getScene().name == \"loginScene\") {\n            var loginSceneMgr = cc.director.getScene().getChildByName(\"Canvas\").getComponent(\"loginSceneMgr\")\n            loginSceneMgr.onPlayerDataUpdated()\n        }\n    },\n\n    commitPlayerDataToServer(dataForCommit, successCallBack) {\n        var networkMgr = require(\"networkMgr\")\n        var msgObj = networkMgr.makeMessageObj(\"dataModule\",\"commitMessageTyp\")\n        msgObj.message.playerId = this.playerData.id\n        if (msgObj.message.playerId == null) {\n            cc.log(\"no player data\")\n            return\n        }\n        \n\n        msgObj.message.commitBody = dataForCommit\n        msgObj.successCallBack = function(xhr) {\n            var response = xhr.responseText\n            response = JSON.parse(response)\n            if (response.type == \"commitSuccess\") {\n                successCallBack()\n            }\n        }\n        networkMgr.sendMessageByMsgObj(msgObj)\n    }\n});\n\nvar shareDataMgr = new dataMgr()\nmodule.exports = shareDataMgr\n"]}